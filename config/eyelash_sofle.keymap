#define ZMK_POINTING_DEFAULT_MOVE_VAL 1200  // 600
#define ZMK_POINTING_DEFAULT_SCRL_VAL 25   // 10

#define L_BASE         0
#define L_TEST         1
#define L_COLEMAK      2

#define L_SYMNUM       3
#define L_NAV          4
#define L_SPECIAL      5
#define L_MOUSE        6 

#define L_JUMP         7 

// TODO: convert left ctrl and alt to right versions, where appropriate
// TODO maybe move the numbers to bottom row?
// idea: add 'one handed mode' layers. e.g. for arrow keys.

#include <input/processors.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/pointing.h>
#include <dt-bindings/zmk/rgb.h>

&mmv_input_listener { input-processors = <&zip_xy_scaler 2 1>; };
&msc_input_listener { input-processors = <&zip_scroll_scaler 2 1>; };
&msc {
    acceleration-exponent = <1>;      // 0
    time-to-max-speed-ms = <100>;       // 300
    delay-ms = <0>;                   // 0
};
&mmv {
    time-to-max-speed-ms = <500>;
    acceleration-exponent = <1>;
    trigger-period-ms = <16>;
};
&soft_off { hold-time-ms = <2000>; };

/ {
    scroll_encoder: scroll_encoder {
        compatible = "zmk,behavior-sensor-rotate";
        #sensor-binding-cells = <0>;
        bindings = <&msc SCRL_DOWN>, <&msc SCRL_UP>;
        tap-ms = <100>;
    };
    behaviors {
         // test tap dance. prints 1 or 2 or 3
         td1: td1 {
            compatible = "zmk,behavior-tap-dance";
            #binding-cells = <0>;
            tapping-term-ms = <200>;
            bindings = <&kp N1>, <&kp N2>, <&kp N3>;
        };
         // bt selection tap dance. the point is to only trigger if really intentional. 1 press prints a dot or something. only triple click works
         // note: i call it 1 but internally it is zero based
         td_bt1: td_bt1 {
            compatible = "zmk,behavior-tap-dance";
            #binding-cells = <0>;
            tapping-term-ms = <200>;
            bindings = <&kp DOT>, <&kp DOT>, <&bt BT_SEL 0>;
        };
    };
    combos {
        compatible = "zmk,combos";
        softoff {
            bindings = <&soft_off>;
            key-positions = <14 28 40>;
        };
        // only active on base and testing layers
        // the key positions -- i counted them from below layout sections
        combo_jk {
            timeout-ms = <50>;
            key-positions = <30 34>;
            bindings = <&caps_word>;
            layers = <0 1>;
        };

        //  test if the key positions are correct. see glossary below
        combo_qw {
            timeout-ms = <50>;
            key-positions = <14 15>;
            bindings = <&kp X>;
            layers = <0 1>;
        };

        // named after the index finger position. the adjacent middle and ring fingers are also pressed
        // to mouse layer
        combo_mxx {
            timeout-ms = <50>;
            key-positions = <47 48 49>;
            bindings = <&to L_MOUSE>;
            //layers = <0 1>;
        };
        // to home layer 
        combo_hxx {
            timeout-ms = <50>;
            key-positions = <33 34 35>;
            bindings = <&to L_BASE>;
            //layers = <0 1>;
        };
        // one-off special/functions layer (aka sticky layer)
        combo_fxx {
            timeout-ms = <50>;
            key-positions = <28 29 30>;
            bindings = <&sl L_SPECIAL>;
            //layers = <0 1>;
        };
        // caps-word
        combo_wxx {
            timeout-ms = <50>;
            key-positions = <15 16 17>;
            bindings = <&caps_word>;
            //layers = <0 1>;
        };
    };

    // but just &kp LC(C) is simpler than macro_copy..
    macros {
    //    macro_copy: macro_copy {
    //    compatible = "zmk,behavior-macro";
    //    #binding-cells = <0>;
    //    bindings = <&kp LC(C)>;
    //    };
    //    macro_paste: macro_paste {
    //    compatible = "zmk,behavior-macro";
    //    #binding-cells = <0>;
    //    bindings = <&kp LC(V)>;
    //    };
    //    macro_cut: macro_cut {
    //    compatible = "zmk,behavior-macro";
    //    #binding-cells = <0>;
    //    bindings = <&kp LC(X)>;
    //    };
    //    macro_redo: macro_redo {
    //    compatible = "zmk,behavior-macro";
    //    #binding-cells = <0>;
    //    bindings = <&kp LC(Y)>;
    //    };
    //    macro_undo: macro_undo {
    //    compatible = "zmk,behavior-macro";
    //    #binding-cells = <0>;
    //    bindings = <&kp LC(Z)>;
    //    };
    };


    keymap {
        compatible = "zmk,keymap";


// GLOSSARY FOR KEY POSITIONS (todo: fill it in)
//=================================================================================================================================================================================================================
//
// 0       1                  2                3            4                  5                   (6)                         7                  8               9                 10           11             12
// 13      q(14)              w(15)            e(16)        r(17               t(18                (6)                       y(20                 u(0             i(22)            o(23)         p(0)           25
// 26      a                  s                d            f(30)              g(31)               (6)                       h(                  j(34)            k(35             l(36          37             38
// 39      z(40               x(41             c(42         v(43               b(44                (6)                       n(46                m(47             48               49            50             51 
//                                                                                                 (6)
//                                                     53 0           0  0  0                                              0 0 0             0 0
//=================================================================================================================================================================================================================




    // Layer Base
    ///////////////////////////////////
    layer0 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &kp ESC &kp Q &kp W &kp E &kp R &kp T  &kp UP_ARROW      &kp Y &kp U &kp I &kp O &kp P &kp DEL
            &mt LCTRL TAB &kp A &kp S &kp D &mt LSHIFT F &kp G  &kp LEFT_ARROW    &kp H &mt RSHIFT J &kp K &kp L &kp SEMI &mt RCTRL APOS
            &kp LSHIFT &kp Z &kp X &kp C &kp V &kp B  &kp RIGHT_ARROW   &kp N &kp M &mt RGUI COMMA &kp DOT &kp FSLH &kp RSHIFT
                                                  &kp C_MUTE
&none &none     &mt LALT ESC &lt L_SYMNUM SPACE &lt L_NAV TAB  &kp ENTER        &none &none     &lt L_NAV ENTER &lt L_SYMNUM SPACE &mt RALT BACKSPACE

            >; display-name = "Base"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer Test
    ///////////////////////////////////
    layer1 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &kp ESC &kp Q &kp W &kp E &kp R &kp T  &kp UP_ARROW      &kp Y &kp U &kp I &kp O &kp P &kp DEL
            &mt LCTRL TAB &kp A &kp S &kp D &mt LSHIFT F &kp G  &kp LEFT_ARROW    &kp H &mt LSHIFT J &kp K &kp L &kp SEMI &mt RCTRL APOS
            &kp LCTRL &kp Z &kp X &kp C &kp V &kp B  &kp RIGHT_ARROW   &kp N &kp M &mt RGUI COMMA &kp DOT &kp FSLH &kp RCTRL
                                                  &kp C_MUTE
&none &none     &mt LALT ESC &lt L_SYMNUM SPACE &lt L_NAV TAB  &kp ENTER        &none &none     &lt L_NAV ENTER &lt L_SYMNUM SPACE &mt RALT BACKSPACE

            >; display-name = "Test"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer Colemak
    ///////////////////////////////////
    layer2 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &trans &kp Q &kp W &kp F &kp P &kp B  &kp UP_ARROW      &kp J &kp L &kp U &kp Y &kp SEMI &trans
            &trans &kp A &mt LALT R &mt LCTRL S &mt LSHIFT T &kp G  &kp LEFT_ARROW    &kp M &mt LSHIFT N &mt LCTRL E &mt LALT I &kp O &kp APOS
            &trans &kp Z &kp X &kp C &kp D &kp V  &kp RIGHT_ARROW   &kp K &kp H &kp COMMA &kp DOT &kp FSLH &trans
                                                  &kp C_MUTE
&none &none     &kp LGUI &trans &trans  &kp ENTER        &none &none     &trans &trans &trans

            >; display-name = "Colemak"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer SymNum
    ///////////////////////////////////
    layer3 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &kp TILDE &kp EXCL &kp AT &kp HASH &kp DOLLAR &kp PRCNT  &kp UP_ARROW      &kp CARET &kp AMPS &kp STAR &kp LPAR &kp RPAR &kp PIPE
            &kp MINUS &kp N1 &mt LALT N2 &mt LCTRL N3 &mt LSHIFT N4 &kp N5  &kp LEFT_ARROW    &kp N6 &mt LSHIFT N7 &mt LCTRL N8 &mt LALT N9 &kp N0 &kp PLUS
            &kp UNDERSCORE &kp LBRC &kp LBKT &kp RBKT &kp RBRC &kp DOT  &kp RIGHT_ARROW   &kp BSLH &kp EQUAL &trans &trans &trans &kp GRAVE
                                                  &kp C_MUTE
&none &none     &trans &trans &kp DOT  &kp ENTER        &none &none     &kp ENTER &trans &trans

            >; display-name = "SymNum"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer Nav
    ///////////////////////////////////
    layer4 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &none &none &none &none &none &none  &kp UP_ARROW      &kp K_REDO &kp K_PASTE &kp K_COPY &kp K_CUT &kp K_UNDO &none
            &none &none &kp LALT &kp LCTRL &kp LSHIFT &none  &kp LEFT_ARROW    &kp LEFT &kp DOWN &kp UP &kp RIGHT &caps_word &none
            &none &kp K_UNDO &kp K_CUT &kp K_COPY &kp K_PASTE &kp K_REDO  &kp RIGHT_ARROW   &kp HOME &kp PG_DN &kp PG_UP &kp END &kp INS &none
                                                  &kp C_MUTE
&none &none     &trans &trans &trans  &kp ENTER        &none &none     &kp ENTER &kp ENTER &kp BSPC

            >; display-name = "Nav"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer Special
    ///////////////////////////////////
    layer5 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &none &none &none &none &none &none  &kp UP_ARROW      &kp F6 &kp F7 &kp F8 &kp F9 &kp F10 &none
            &none &kp F1 &kp F2 &kp F3 &kp F4 &kp F5  &kp LEFT_ARROW    &none &none &none &none &none &none
            &out OUT_BLE &bt BT_SEL 0 &bt BT_SEL 1 &bt BT_SEL 2 &bt BT_SEL 3 &kp PAUSE_BREAK  &kp RIGHT_ARROW   &none &none &none &none &none &out OUT_USB
                                                  &kp C_MUTE
&none &none     &td_bt1 &trans &trans  &kp ENTER        &none &none     &kp ENTER &trans &trans

            >; display-name = "Special"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer Mouse
    ///////////////////////////////////
    layer6 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &none &none &kp C_PREV &kp C_PP &kp C_NEXT &none  &kp UP_ARROW      &kp K_REDO &kp K_PASTE &kp K_COPY &kp K_CUT &kp K_UNDO &none
            &none &kp C_BRI_DN &kp C_BRI_UP &kp C_VOL_UP &kp C_VOL_DN &kp C_MUTE  &kp LEFT_ARROW    &mmv MOVE_LEFT &mmv MOVE_DOWN &mmv MOVE_UP &mmv MOVE_RIGHT &none &none
            &none &kp K_UNDO &kp K_CUT &kp K_COPY &kp K_PASTE &kp K_REDO  &kp RIGHT_ARROW   &msc SCRL_LEFT &msc SCRL_DOWN &msc SCRL_UP &msc SCRL_RIGHT &none &none
                                                  &kp C_MUTE
&none &none     &trans &trans &trans  &kp ENTER        &none &none     &kp ENTER &mkp RCLK &mkp LCLK

            >; display-name = "Mouse"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    // Layer Jump
    ///////////////////////////////////
    layer7 {
    bindings = <

       &none  &none &none &none &none &none       &kp UP_ARROW           &none &none &none &none &none &none
            &kp ESC &kp Q &kp W &kp E &kp R &kp T  &kp UP_ARROW      &to L_COLEMAK &to L_TEST &to L_MOUSE &to L_SPECIAL &to L_JUMP &kp DEL
            &caps_word &kp A &to L_SPECIAL &mt LCTRL D &mt LSHIFT F &kp G  &kp LEFT_ARROW    &kp X &mt LSHIFT J &mt LCTRL K &mt LALT L &kp SEMI &kp APOS
            &kp LSHIFT &kp Z &kp X &kp C &kp V &kp B  &kp RIGHT_ARROW   &kp N &to L_MOUSE &kp COMMA &kp DOT &kp FSLH &kp RSHIFT
                                                  &kp C_MUTE
&none &none     &kp LGUI &trans &lt L_MOUSE ESC  &kp ENTER        &none &none     &lt L_NAV ENTER &lt L_SYMNUM SPACE &lt L_SPECIAL BACKSPACE

            >; display-name = "Jump"; sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>; };



    };
};